import { require_vue } from "./chunk-PTXHTZXM.js";
import { Current, addLeadingSlash, ensure, eventHandler, getPageInstance, hooks, incrementId, injectPageInstance, isArray, isFunction, isUndefined, removePageInstance, safeExecute } from "./chunk-IRQUUVTE.js";
import { __toESM } from "./chunk-P7VEE7PG.js";
// ../../node_modules/.pnpm/@tarojs+plugin-framework-vue3@3.6.2_vue@3.2.47/node_modules/@tarojs/plugin-framework-vue3/dist/runtime.js
var import_vue = __toESM(require_vue());
function createTaroHook(lifecycle) {
    return (fn)=>{
        const id = (0, import_vue.inject)("id");
        const fnRef = (0, import_vue.ref)(fn);
        let inst;
        let callback;
        (0, import_vue.onMounted)(()=>{
            inst = getPageInstance(id);
            if (inst === void 0) {
                inst = /* @__PURE__ */ Object.create({
                    $options: {}
                });
                injectPageInstance(inst, id);
            }
            inst = inst.$options;
            callback = (...args)=>fnRef.value(...args);
            const currentCallback = inst[lifecycle];
            if (isUndefined(currentCallback)) {
                inst[lifecycle] = callback;
            } else if (isFunction(currentCallback)) {
                inst[lifecycle] = [
                    inst[lifecycle],
                    callback
                ];
            } else if (isArray(currentCallback)) {
                inst[lifecycle] = [
                    ...currentCallback,
                    callback
                ];
            }
        });
        (0, import_vue.onUnmounted)(()=>{
            if (!inst || !callback) {
                return;
            }
            const list = inst[lifecycle];
            if (list === callback) {
                inst[lifecycle] = void 0;
            } else if (isArray(list)) {
                inst[lifecycle] = list.filter((item)=>item !== callback);
            }
            inst = null;
            callback = null;
        });
    };
}
var useDidShow = createTaroHook("onShow");
var useDidHide = createTaroHook("onHide");
var useLoad = createTaroHook("onLoad");
var usePageScroll = createTaroHook("onPageScroll");
var usePullDownRefresh = createTaroHook("onPullDownRefresh");
var usePullIntercept = createTaroHook("onPullIntercept");
var useReachBottom = createTaroHook("onReachBottom");
var useResize = createTaroHook("onResize");
var useUnload = createTaroHook("onUnload");
var useAddToFavorites = createTaroHook("onAddToFavorites");
var useOptionMenuClick = createTaroHook("onOptionMenuClick");
var useSaveExitState = createTaroHook("onSaveExitState");
var useShareAppMessage = createTaroHook("onShareAppMessage");
var useShareTimeline = createTaroHook("onShareTimeline");
var useTitleClick = createTaroHook("onTitleClick");
var useReady = createTaroHook("onReady");
var useRouter = ()=>{
    return Current.router;
};
var useTabItemTap = createTaroHook("onTabItemTap");
var taroHooks = Object.freeze({
    __proto__: null,
    useAddToFavorites,
    useDidHide,
    useDidShow,
    useLoad,
    useOptionMenuClick,
    usePageScroll,
    usePullDownRefresh,
    usePullIntercept,
    useReachBottom,
    useReady,
    useResize,
    useRouter,
    useSaveExitState,
    useShareAppMessage,
    useShareTimeline,
    useTabItemTap,
    useTitleClick,
    useUnload
});
var setGlobalDataPlugin = {
    install: (app, data)=>{
        app.taroGlobalData = data;
    }
};
function setDefaultDescriptor(obj) {
    obj.writable = true;
    obj.enumerable = true;
    return obj;
}
function setRouterParams(options) {
    Current.router = Object.assign({
        params: options === null || options === void 0 ? void 0 : options.query
    }, options);
}
function setReconciler() {
    hooks.tap("getLifecycle", function(instance, lifecycle) {
        return instance.$options[lifecycle];
    });
    if (true) {
        hooks.tap("createPullDownComponent", (component, path, h)=>{
            const inject2 = {
                props: {
                    tid: String
                },
                created () {
                    injectPageInstance(this, path);
                }
            };
            component.mixins = isArray(component.mixins) ? component.mixins.push(inject2) : [
                inject2
            ];
            return {
                render () {
                    return h("taro-pull-to-refresh", {
                        class: "hydrated"
                    }, [
                        h(component, this.$slots.default)
                    ]);
                }
            };
        });
        hooks.tap("getDOMNode", (el)=>{
            return el.$el;
        });
    }
}
function createVue3Page(h, id) {
    return function(component) {
        var _a, _b, _c, _d;
        component = isClassComponent(component) ? component.__vccOpts : component;
        const inject2 = {
            props: {
                tid: String
            },
            created () {
                injectPageInstance(this, id);
            }
        };
        if (isArray(component.mixins)) {
            const mixins = component.mixins;
            const idx = mixins.length - 1;
            if (!((_a = mixins[idx].props) === null || _a === void 0 ? void 0 : _a.tid)) {
                component.mixins.push(inject2);
            } else {
                component.mixins[idx] = inject2;
            }
        } else {
            component.mixins = [
                inject2
            ];
        }
        const ProviderComponent = {
            setup () {
                (0, import_vue.provide)("id", id);
            },
            render () {
                return this.$slots.default();
            }
        };
        const RootElement = true ? "div" : "root";
        const PageComponent = Object.assign({}, component);
        const option = ((_d = (_c = (_b = PageComponent.props) === null || _b === void 0 ? void 0 : _b.option) === null || _c === void 0 ? void 0 : _c.default) === null || _d === void 0 ? void 0 : _d.call(_c)) || {};
        return h(ProviderComponent, {
            key: id
        }, {
            default () {
                return [
                    h(RootElement, {
                        id,
                        class: true ? "taro_page" : ""
                    }, [
                        h(PageComponent, {
                            tid: id,
                            option
                        })
                    ])
                ];
            }
        });
    };
}
function createVue3App(app, h, config) {
    let pages = [];
    let appInstance;
    ensure(!(isFunction(app._component) && !isClassComponent(app._component)), "\u5165\u53E3\u7EC4\u4EF6\u4E0D\u652F\u6301\u4F7F\u7528\u51FD\u6570\u5F0F\u7EC4\u4EF6");
    setReconciler();
    app._component.render = function() {
        return pages.slice();
    };
    if (false) {
        appInstance = app.mount("#app");
    }
    const [ONLAUNCH, ONSHOW, ONHIDE] = hooks.call("getMiniLifecycleImpl").app;
    const appConfig = Object.create({
        mount (component, id, cb) {
            const page = createVue3Page(h, id)(component);
            pages.push(page);
            this.updateAppInstance(cb);
        },
        unmount (id, cb) {
            pages = pages.filter((page)=>page.key !== id);
            this.updateAppInstance(cb);
        },
        updateAppInstance (cb) {
            appInstance.$forceUpdate();
            appInstance.$nextTick(cb);
        }
    }, {
        config: setDefaultDescriptor({
            configurable: true,
            value: config
        }),
        [ONLAUNCH]: setDefaultDescriptor({
            value (options) {
                var _a;
                setRouterParams(options);
                if (true) {
                    appInstance = app.mount(`#${config.appId || "app"}`);
                }
                if (app["taroGlobalData"]) {
                    const globalData = app["taroGlobalData"];
                    const keys = Object.keys(globalData);
                    const descriptors = Object.getOwnPropertyDescriptors(globalData);
                    keys.forEach((key)=>{
                        Object.defineProperty(this, key, {
                            configurable: true,
                            enumerable: true,
                            get () {
                                return globalData[key];
                            },
                            set (value) {
                                globalData[key] = value;
                            }
                        });
                    });
                    Object.defineProperties(this, descriptors);
                }
                const onLaunch = (_a = appInstance === null || appInstance === void 0 ? void 0 : appInstance.$options) === null || _a === void 0 ? void 0 : _a.onLaunch;
                isFunction(onLaunch) && onLaunch.call(appInstance, options);
            }
        }),
        [ONSHOW]: setDefaultDescriptor({
            value (options) {
                var _a;
                setRouterParams(options);
                const onShow = (_a = appInstance === null || appInstance === void 0 ? void 0 : appInstance.$options) === null || _a === void 0 ? void 0 : _a.onShow;
                isFunction(onShow) && onShow.call(appInstance, options);
            }
        }),
        [ONHIDE]: setDefaultDescriptor({
            value (options) {
                var _a;
                const onHide = (_a = appInstance === null || appInstance === void 0 ? void 0 : appInstance.$options) === null || _a === void 0 ? void 0 : _a.onHide;
                isFunction(onHide) && onHide.call(appInstance, options);
            }
        }),
        onError: setDefaultDescriptor({
            value (error) {
                var _a;
                const onError = (_a = appInstance === null || appInstance === void 0 ? void 0 : appInstance.$options) === null || _a === void 0 ? void 0 : _a.onError;
                isFunction(onError) && onError.call(appInstance, error);
            }
        }),
        onUnhandledRejection: setDefaultDescriptor({
            value (error) {
                var _a;
                const onUnhandledRejection = (_a = appInstance === null || appInstance === void 0 ? void 0 : appInstance.$options) === null || _a === void 0 ? void 0 : _a.onUnhandledRejection;
                isFunction(onUnhandledRejection) && onUnhandledRejection.call(appInstance, error);
            }
        }),
        onPageNotFound: setDefaultDescriptor({
            value (res) {
                var _a;
                const onPageNotFound = (_a = appInstance === null || appInstance === void 0 ? void 0 : appInstance.$options) === null || _a === void 0 ? void 0 : _a.onPageNotFound;
                isFunction(onPageNotFound) && onPageNotFound.call(appInstance, res);
            }
        })
    });
    Current.app = appConfig;
    return appConfig;
}
function isClassComponent(value) {
    return isFunction(value) && "__vccOpts" in value;
}
var getNativeCompId = incrementId();
function initNativeComponentEntry(h) {
    setReconciler();
    const NativeComponentWrapper = {
        props: [
            "getCtx",
            "compId"
        ],
        setup (props) {
            const root = (0, import_vue.ref)();
            const ctx = props.getCtx();
            (0, import_vue.provide)("id", props.compId);
            (0, import_vue.onMounted)(()=>{
                const rootElement = (0, import_vue.toRaw)(root.value);
                rootElement.ctx = ctx;
                rootElement.performUpdate(true);
            });
            return {
                root
            };
        },
        render () {
            return h("root", {
                ref: "root",
                id: this.compId
            }, this.$slots.default());
        }
    };
    const App = (0, import_vue.defineComponent)({
        setup () {
            const components = (0, import_vue.shallowReactive)([]);
            function mount(component, compId, getCtx) {
                var _a, _b, _c, _d;
                component = isClassComponent(component) ? component.__vccOpts : component;
                const inject2 = {
                    props: {
                        tid: String
                    },
                    created () {
                        injectPageInstance(this, compId);
                    }
                };
                if (isArray(component.mixins)) {
                    const mixins = component.mixins;
                    const idx = mixins.length - 1;
                    if (!((_a = mixins[idx].props) === null || _a === void 0 ? void 0 : _a.tid)) {
                        component.mixins.push(inject2);
                    } else {
                        component.mixins[idx] = inject2;
                    }
                } else {
                    component.mixins = [
                        inject2
                    ];
                }
                const PageComponent = Object.assign({}, component);
                const option = ((_d = (_c = (_b = PageComponent.props) === null || _b === void 0 ? void 0 : _b.option) === null || _c === void 0 ? void 0 : _c.default) === null || _d === void 0 ? void 0 : _d.call(_c)) || {};
                const ctx = getCtx();
                const page = {
                    mounted () {
                        ctx.component = this;
                    },
                    unmounted () {
                        removePageInstance(compId);
                    },
                    render () {
                        return h(NativeComponentWrapper, {
                            compId,
                            getCtx
                        }, {
                            default () {
                                return [
                                    h(PageComponent, Object.assign(Object.assign({
                                        tid: compId,
                                        option
                                    }, (ctx.data || (ctx.data = {})).props), {
                                        _scope: ctx
                                    }))
                                ];
                            }
                        });
                    }
                };
                components.push({
                    compId,
                    component: page
                });
            }
            function unmount(compId) {
                const index = components.findIndex((page)=>page.compId === compId);
                components.splice(index, 1);
            }
            (0, import_vue.onMounted)(()=>Current.app = {
                    mount,
                    unmount
                });
            return {
                components
            };
        },
        render () {
            return this.components.map((page)=>h(page.component, {
                    key: page.compId
                }));
        }
    });
    (0, import_vue.createApp)(App).mount("#app");
}
function createNativeComponentConfig(component, h, componentConfig) {
    const componentObj = {
        options: componentConfig,
        properties: {
            props: {
                type: null,
                value: null,
                observer (_newVal, oldVal) {
                    var _a;
                    oldVal && ((_a = this.component) === null || _a === void 0 ? void 0 : _a.$forceUpdate());
                }
            }
        },
        created () {
            if (!Current.app) {
                initNativeComponentEntry(h);
            }
        },
        attached () {
            const compId = this.compId = getNativeCompId();
            setCurrent(compId);
            this.config = componentConfig;
            Current.app.mount(component, compId, ()=>this);
        },
        ready () {
            safeExecute(this.compId, "onReady");
        },
        detached () {
            resetCurrent();
            Current.app.unmount(this.compId);
            this.component = null;
        },
        pageLifetimes: {
            show (options) {
                safeExecute(this.compId, "onShow", options);
            },
            hide () {
                safeExecute(this.compId, "onHide");
            }
        },
        methods: {
            eh: eventHandler
        }
    };
    function resetCurrent() {
        Current.page = null;
        Current.router = null;
    }
    function setCurrent(compId) {
        const pages = getCurrentPages();
        const currentPage = pages[pages.length - 1];
        if (Current.page === currentPage) return;
        Current.page = currentPage;
        const route = currentPage.route || currentPage.__route__;
        const router = {
            params: currentPage.options || {},
            path: addLeadingSlash(route),
            $taroPath: compId,
            onReady: "",
            onHide: "",
            onShow: ""
        };
        Current.router = router;
        if (!currentPage.options) {
            Object.defineProperty(currentPage, "options", {
                enumerable: true,
                configurable: true,
                get () {
                    return this._optionsValue;
                },
                set (value) {
                    router.params = value;
                    this._optionsValue = value;
                }
            });
        }
    }
    return componentObj;
}
hooks.tap("initNativeApi", function(taro) {
    for(const hook in taroHooks){
        taro[hook] = taroHooks[hook];
    }
    taro.setGlobalDataPlugin = setGlobalDataPlugin;
});
export { useDidShow, useDidHide, useLoad, usePageScroll, usePullDownRefresh, usePullIntercept, useReachBottom, useResize, useUnload, useAddToFavorites, useOptionMenuClick, useSaveExitState, useShareAppMessage, useShareTimeline, useTitleClick, useReady, useRouter, useTabItemTap, setGlobalDataPlugin, setReconciler, createVue3App, isClassComponent, createNativeComponentConfig };
